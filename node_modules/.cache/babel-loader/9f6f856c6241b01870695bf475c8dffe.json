{"ast":null,"code":"var _s = $RefreshSig$();\n\nimport axios from 'axios';\nimport jwt_decode from \"jwt-decode\";\nimport { useContext } from 'react';\nimport { AuthContext } from '../context/AuthContext';\n\nconst useRefreshToken = () => {\n  _s();\n\n  const {\n    userAuth,\n    setUserAuth,\n    logOut\n  } = useContext(AuthContext);\n  const baseURL = \"http://localhost:8080/api\";\n  const refreshURL = `${baseURL}/users/token/refresh`;\n  const axiosInstance = axios.create({\n    baseURL: baseURL,\n    timeout: 10000,\n    headers: {\n      'Authorization': `Bearer ${userAuth.accessToken}`\n    }\n  });\n\n  const refreshToken = async () => {\n    const config = {\n      headers: {\n        'Authorization': `Bearer ${userAuth.refreshToken}`\n      }\n    };\n    const response = await axios.get(refreshURL, config); // log out if request unsuccessful due to expired token\n\n    window.localStorage.setItem(\"access_token\", response.data.access_token);\n    setUserAuth(prevState => ({\n      username: prevState.username,\n      accessToken: response.data.access_token,\n      refreshToken: prevState.refreshToken\n    }));\n    return response.data.access_token;\n  }; // axiosInstance.interceptors.request.use(async request => {\n  // \tconst decodedToken = jwt_decode(userAuth.accessToken);\n  // \tconst tokenExpirationDate = decodedToken.exp;\n  // \tconst currentTime = new Date().getTime() / 1000;\n  // \tconst isValid = tokenExpirationDate > currentTime;\n  // \tif (isValid) return request;\n  // \tconst refreshedToken = await refreshToken();\n  // \trequest.headers.Authorization = `Bearer ${refreshedToken}`;\n  // \treturn request;\n  // \t}, error => {\n  // \t\treturn Promise.reject(error);\n  // });\n\n\n  axios.interceptors.response.use(response => {\n    return response;\n  }, async error => {\n    if (error.response.status !== 403) return error;\n    const refreshedToken = await refreshToken();\n    const config = error.config;\n    config.headers.Authorization = `Bearer ${refreshedToken}`;\n    return new Promise((resolve, reject) => {\n      axios.request(config).then(response => {\n        resolve(response);\n      }).catch(error => {\n        reject(error);\n      });\n    });\n  });\n  return axiosInstance;\n};\n\n_s(useRefreshToken, \"X45xrHcNiTYN3W9ev84RTlsrhY0=\");\n\nexport default useRefreshToken;","map":{"version":3,"sources":["/Users/agusespa/Programming/Projects/self-okrs-ui/src/utils/useRefreshToken.js"],"names":["axios","jwt_decode","useContext","AuthContext","useRefreshToken","userAuth","setUserAuth","logOut","baseURL","refreshURL","axiosInstance","create","timeout","headers","accessToken","refreshToken","config","response","get","window","localStorage","setItem","data","access_token","prevState","username","interceptors","use","error","status","refreshedToken","Authorization","Promise","resolve","reject","request","then","catch"],"mappings":";;AAAA,OAAOA,KAAP,MAAkB,OAAlB;AACA,OAAOC,UAAP,MAAuB,YAAvB;AACA,SAASC,UAAT,QAA2B,OAA3B;AACA,SAASC,WAAT,QAA4B,wBAA5B;;AAEA,MAAMC,eAAe,GAAG,MAAM;AAAA;;AAE1B,QAAM;AAAEC,IAAAA,QAAF;AAAYC,IAAAA,WAAZ;AAAyBC,IAAAA;AAAzB,MAAoCL,UAAU,CAACC,WAAD,CAApD;AAEH,QAAMK,OAAO,GAAG,2BAAhB;AACA,QAAMC,UAAU,GAAI,GAAED,OAAQ,sBAA9B;AAEA,QAAME,aAAa,GAAGV,KAAK,CAACW,MAAN,CAAa;AAClCH,IAAAA,OAAO,EAAEA,OADyB;AAElCI,IAAAA,OAAO,EAAE,KAFyB;AAGlCC,IAAAA,OAAO,EAAE;AAAE,uBAAkB,UAASR,QAAQ,CAACS,WAAY;AAAlD;AAHyB,GAAb,CAAtB;;AAMA,QAAMC,YAAY,GAAG,YAAY;AAEhC,UAAMC,MAAM,GAAG;AACdH,MAAAA,OAAO,EAAE;AACR,yBAAkB,UAASR,QAAQ,CAACU,YAAa;AADzC;AADK,KAAf;AAMA,UAAME,QAAQ,GAAG,MAAMjB,KAAK,CAACkB,GAAN,CAAUT,UAAV,EAAsBO,MAAtB,CAAvB,CARgC,CAUhC;;AAEAG,IAAAA,MAAM,CAACC,YAAP,CAAoBC,OAApB,CAA4B,cAA5B,EAA4CJ,QAAQ,CAACK,IAAT,CAAcC,YAA1D;AAEAjB,IAAAA,WAAW,CAACkB,SAAS,KAAM;AAC1BC,MAAAA,QAAQ,EAAED,SAAS,CAACC,QADM;AAE1BX,MAAAA,WAAW,EAAEG,QAAQ,CAACK,IAAT,CAAcC,YAFD;AAG1BR,MAAAA,YAAY,EAAES,SAAS,CAACT;AAHE,KAAN,CAAV,CAAX;AAMA,WAAOE,QAAQ,CAACK,IAAT,CAAcC,YAArB;AAEA,GAtBD,CAb6B,CAqC7B;AAEA;AACA;AACA;AAEA;AAEA;AAEA;AAEA;AACA;AAEA;AACA;AACA;;;AAGAvB,EAAAA,KAAK,CAAC0B,YAAN,CAAmBT,QAAnB,CAA4BU,GAA5B,CAAiCV,QAAQ,IAAI;AAE5C,WAAOA,QAAP;AAEC,GAJF,EAII,MAAMW,KAAN,IAAe;AAEjB,QAAIA,KAAK,CAACX,QAAN,CAAeY,MAAf,KAA0B,GAA9B,EAAmC,OAAOD,KAAP;AAEnC,UAAME,cAAc,GAAG,MAAMf,YAAY,EAAzC;AAEA,UAAMC,MAAM,GAAGY,KAAK,CAACZ,MAArB;AAEAA,IAAAA,MAAM,CAACH,OAAP,CAAekB,aAAf,GAAgC,UAASD,cAAe,EAAxD;AAEA,WAAO,IAAIE,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACvClC,MAAAA,KAAK,CAACmC,OAAN,CAAcnB,MAAd,EAAsBoB,IAAtB,CAA2BnB,QAAQ,IAAI;AACrCgB,QAAAA,OAAO,CAAChB,QAAD,CAAP;AACD,OAFD,EAEGoB,KAFH,CAEUT,KAAD,IAAW;AAClBM,QAAAA,MAAM,CAACN,KAAD,CAAN;AACD,OAJD;AAKA,KANM,CAAP;AASD,GAvBD;AAyBG,SAAOlB,aAAP;AACH,CAnFD;;GAAMN,e;;AAqFN,eAAeA,eAAf","sourcesContent":["import axios from 'axios';\nimport jwt_decode from \"jwt-decode\";\nimport { useContext } from 'react';\nimport { AuthContext } from '../context/AuthContext';\n\nconst useRefreshToken = () => {\n\n    const { userAuth, setUserAuth, logOut } = useContext(AuthContext);\n\n\tconst baseURL = \"http://localhost:8080/api\";\n\tconst refreshURL = `${baseURL}/users/token/refresh`; \n\n\tconst axiosInstance = axios.create({\n\t\tbaseURL: baseURL,\n\t\ttimeout: 10000,\n\t\theaders: { 'Authorization': `Bearer ${userAuth.accessToken}`}\n\t});\n\n\tconst refreshToken = async () => {\n\n\t\tconst config = {\n\t\t\theaders: {\n\t\t\t\t'Authorization': `Bearer ${userAuth.refreshToken}`\n\t\t\t}\n\t\t}\n\n\t\tconst response = await axios.get(refreshURL, config);\n\n\t\t// log out if request unsuccessful due to expired token\n\t\t\t\t\n\t\twindow.localStorage.setItem(\"access_token\", response.data.access_token);\n\n\t\tsetUserAuth(prevState => ( {\n\t\t\tusername: prevState.username,\n\t\t\taccessToken: response.data.access_token,\n\t\t\trefreshToken: prevState.refreshToken\n\t\t}));\n\n\t\treturn response.data.access_token;\n\n\t}\n\n\t// axiosInstance.interceptors.request.use(async request => {\n\n\t// \tconst decodedToken = jwt_decode(userAuth.accessToken);\n\t// \tconst tokenExpirationDate = decodedToken.exp;\n\t// \tconst currentTime = new Date().getTime() / 1000;\n\t\n\t// \tconst isValid = tokenExpirationDate > currentTime;\n\t\n\t// \tif (isValid) return request;\n\n\t// \tconst refreshedToken = await refreshToken();\n\t\t\n\t// \trequest.headers.Authorization = `Bearer ${refreshedToken}`;\n\t// \treturn request;\n\n\t// \t}, error => {\n\t// \t\treturn Promise.reject(error);\n\t// });\n\n\n\taxios.interceptors.response.use( response => {\n\n\t\treturn response;\n\t\t\n\t\t}, async error => {\n\n\t\t\tif (error.response.status !== 403) return error;\n\t\n\t\t\tconst refreshedToken = await refreshToken();\n\n\t\t\tconst config = error.config;\n\n\t\t\tconfig.headers.Authorization = `Bearer ${refreshedToken}`;\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\taxios.request(config).then(response => {\n\t\t\t\t  resolve(response);\n\t\t\t\t}).catch((error) => {\n\t\t\t\t  reject(error);\n\t\t\t\t})\n\t\t\t});\n\t  \n\t\t\t\n\t});\n    \n    return axiosInstance;\n}\n\nexport default useRefreshToken;"]},"metadata":{},"sourceType":"module"}